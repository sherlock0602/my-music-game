<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Neon Beat - Waveform Master V3</title>
    <style>
        body { 
            background: #121212; color: #e0e0e0; font-family: 'Segoe UI', monospace; 
            display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden;
        }

        /* é ‚éƒ¨å·¥å…·åˆ— */
        #toolbar {
            background: #1e1e1e; padding: 10px 20px; border-bottom: 1px solid #333;
            display: flex; gap: 15px; align-items: center; justify-content: space-between;
            z-index: 20; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .control-group { display: flex; align-items: center; gap: 10px; }
        
        button {
            background: #333; border: 1px solid #555; color: #fff; 
            padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: 0.2s;
            font-size: 13px;
        }
        button:hover { background: #444; border-color: #888; }
        button.primary { background: #00bcd4; color: #000; border: none; font-weight: bold; }
        button.primary:hover { background: #00acc1; }
        button.active { background: #4caf50; border-color: #4caf50; }

        /* é€²åº¦æ¢èˆ‡æ™‚é–“ */
        #transport-bar {
            background: #252525; padding: 5px 20px; display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid #333;
        }
        #seek-slider { flex: 1; cursor: pointer; height: 5px; accent-color: #00bcd4; }
        #time-display { color: #00bcd4; font-size: 14px; min-width: 80px; text-align: right; }

        /* ä¸»ç·¨è¼¯å€ */
        #viewport {
            position: relative; flex: 1; background: #000; overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* ä¸­å¿ƒç·š (Playhead) */
        #playhead {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; 
            background: rgba(255, 50, 50, 0.8); pointer-events: none; z-index: 10;
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
        }

        /* è»Œé“æ¨™è¨˜ */
        .lane-guide {
            position: absolute; left: 0; right: 0; border-bottom: 1px solid rgba(255,255,255,0.05);
            pointer-events: none;
        }
        .lane-text {
            position: absolute; left: 10px; color: rgba(255,255,255,0.3); 
            font-size: 20px; font-weight: bold; pointer-events: none; z-index: 5;
            display: flex; align-items: center; height: 100%;
        }

        /* æª”æ¡ˆé®ç½© */
        #overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #loading-box { display: none; text-align: center; }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333; border-top-color: #00bcd4;
            border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* è¼¸å‡ºé¢æ¿ */
        #export-modal {
            position: absolute; bottom: 0; right: 0; width: 300px; height: 200px;
            background: #1e1e1e; border: 1px solid #333; z-index: 50;
            display: none; flex-direction: column; padding: 10px;
            box-shadow: -5px -5px 20px rgba(0,0,0,0.5);
        }
        textarea { flex: 1; background: #111; color: #0f0; border: 1px solid #333; resize: none; font-size: 11px; }

        /* ç‹€æ…‹åˆ— */
        #status-bar {
            position: absolute; bottom: 10px; left: 10px; font-size: 12px; color: #666; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="overlay">
    <div id="init-box">
        <h1 style="color:#fff; margin-bottom:10px;">NEON MAKER <span style="color:#00bcd4; font-size:16px;">V3</span></h1>
        <p style="color:#888; margin-bottom:30px;">é«˜å°æ¯”æ³¢å½¢è¦–è¦ºåŒ–ç·¨è¼¯å™¨</p>
        <button class="primary" style="padding:15px 40px; font-size:18px;" onclick="document.getElementById('file-input').click()">ğŸ“‚ é¸æ“‡ MP3 éŸ³æ¨‚</button>
        <input type="file" id="file-input" accept="audio/*" onchange="loadAudio(this)" style="display:none;">
    </div>
    <div id="loading-box">
        <div class="spinner"></div>
        <div id="loading-msg" style="color:#fff; font-size:18px;">æ­£åœ¨è§£ææ³¢å½¢...</div>
    </div>
</div>

<div id="toolbar">
    <div class="control-group">
        <strong style="color:#00bcd4;">EDITOR</strong>
        <button onclick="zoom(-500)">ğŸ” ç¸®å°</button>
        <button onclick="zoom(500)">ğŸ” æ”¾å¤§</button>
    </div>
    <div class="control-group">
        <span>é€Ÿåº¦:</span>
        <button onclick="setSpeed(0.5)">0.5x</button>
        <button onclick="setSpeed(1.0)" class="active" id="btn-speed-1">1.0x</button>
    </div>
    <div class="control-group">
        <button onclick="toggleExport()">ğŸ’¾ åŒ¯å‡ºæ•¸æ“š</button>
    </div>
</div>

<div id="transport-bar">
    <button onclick="togglePlay()" id="play-btn" style="width:80px;">â–¶ æ’­æ”¾</button>
    <button onclick="stop()">â–  åœæ­¢</button>
    <input type="range" id="seek-slider" value="0" step="0.001">
    <span id="time-display">00:00.00</span>
</div>

<div id="viewport">
    <div id="playhead"></div>
    <div id="status-bar">æº–å‚™å°±ç·’</div>
    
    <div class="lane-guide" style="top:0; height:25%;"><div class="lane-text">D</div></div>
    <div class="lane-guide" style="top:25%; height:25%;"><div class="lane-text">F</div></div>
    <div class="lane-guide" style="top:50%; height:25%;"><div class="lane-text">J</div></div>
    <div class="lane-guide" style="top:75%; height:25%;"><div class="lane-text">K</div></div>
    
    <canvas id="canvas"></canvas>
</div>

<div id="export-modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <span>JSON æ•¸æ“š</span>
        <div>
            <button onclick="copyJson()" style="padding:2px 8px;">è¤‡è£½</button>
            <button onclick="toggleExport()" style="padding:2px 8px;">é—œé–‰</button>
        </div>
    </div>
    <textarea id="json-text"></textarea>
</div>

<script>
    // --- ç³»çµ±è®Šæ•¸ ---
    const LANE_KEYS = ['d', 'f', 'j', 'k'];
    const LANE_COLORS = ['#FFD700', '#00BFFF', '#00FF88', '#BD00FF'];
    let TIME_WINDOW = 3000; // è¦–çª—é¡¯ç¤ºç¯„åœ (ms)
    
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let audioBuffer = null;
    let sourceNode = null;
    
    let isPlaying = false;
    let startTime = 0;       // æ’­æ”¾é–‹å§‹çš„ context æ™‚é–“
    let pauseOffset = 0;     // æš«åœæ™‚çš„é€²åº¦ (ç§’)
    let playbackRate = 1.0;

    let waveform = []; // å„²å­˜æ³¢å½¢æ•¸æ“š
    let notes = [];    // å„²å­˜éŸ³ç¬¦ {time, lane}

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const slider = document.getElementById('seek-slider');
    const timeDisp = document.getElementById('time-display');
    const statusDiv = document.getElementById('status-bar');

    // --- 1. æª”æ¡ˆè¼‰å…¥èˆ‡è§£æ ---
    async function loadAudio(input) {
        if (!input.files.length) return;
        const file = input.files[0];

        // UI åˆ‡æ›
        document.getElementById('init-box').style.display = 'none';
        document.getElementById('loading-box').style.display = 'block';

        try {
            const arrayBuffer = await file.arrayBuffer();
            // è§£ç¢¼éŸ³è¨Š
            audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            
            // è™•ç†æ³¢å½¢
            generateWaveform();
            
            // å®Œæˆ
            slider.max = audioBuffer.duration;
            document.getElementById('overlay').style.display = 'none';
            resize();
            draw();
            statusDiv.innerText = `è¼‰å…¥æˆåŠŸ: ${audioBuffer.duration.toFixed(1)}ç§’ | æ³¢å½¢é»æ•¸: ${waveform.length}`;

        } catch (e) {
            console.error(e);
            alert("æª”æ¡ˆè§£æå¤±æ•—ï¼è«‹ç¢ºèªæ˜¯æ­£å¸¸çš„ MP3/WAV æª”æ¡ˆã€‚");
            location.reload();
        }
    }

    // --- 2. æ³¢å½¢ç”Ÿæˆ (V3: æ­£è¦åŒ– + é«˜å°æ¯”) ---
    function generateWaveform() {
        const raw = audioBuffer.getChannelData(0); // å–å–®è²é“
        const sampleRate = audioBuffer.sampleRate;
        const samplesPerPixel = 100; // è§£æåº¦
        const step = Math.floor(sampleRate / 100); // æ¯ 10ms å–æ¨£ä¸€æ¬¡
        
        waveform = [];
        let maxVal = 0;

        // ç¬¬ä¸€éï¼šå–æ¨£ä¸¦æ‰¾å‡ºæœ€å¤§å€¼ (ç‚ºäº†æ­£è¦åŒ–)
        for (let i = 0; i < raw.length; i += step) {
            let sum = 0;
            // å–å°å€é–“çš„çµ•å°å€¼å¹³å‡
            for(let j=0; j<step && (i+j)<raw.length; j+=10) {
                sum += Math.abs(raw[i+j]);
            }
            const val = sum / (step/10);
            if(val > maxVal) maxVal = val;
            waveform.push(val);
        }

        // ç¬¬äºŒéï¼šæ­£è¦åŒ– (è®“æ³¢å½¢å¡«æ»¿ç•«é¢)
        if(maxVal > 0) {
            for(let i=0; i<waveform.length; i++) {
                waveform[i] = waveform[i] / maxVal; 
            }
        }
    }

    // --- 3. æ’­æ”¾å¼•æ“ (ä½¿ç”¨ Web Audio API source node ä»¥ç²å¾—æœ€ä½³åŒæ­¥) ---
    function play() {
        if(isPlaying) return;
        
        sourceNode = audioCtx.createBufferSource();
        sourceNode.buffer = audioBuffer;
        sourceNode.playbackRate.value = playbackRate;
        sourceNode.connect(audioCtx.destination);
        
        startTime = audioCtx.currentTime;
        sourceNode.start(0, pauseOffset); // å¾æš«åœè™•é–‹å§‹
        
        isPlaying = true;
        document.getElementById('play-btn').innerText = "â¸ æš«åœ";
        animate();
    }

    function pause() {
        if(!isPlaying) return;
        sourceNode.stop();
        sourceNode = null;
        // ç´€éŒ„æš«åœä½ç½® = å·²ç¶“æ’­çš„æ™‚é–“ * é€Ÿåº¦
        pauseOffset += (audioCtx.currentTime - startTime) * playbackRate;
        
        isPlaying = false;
        document.getElementById('play-btn').innerText = "â–¶ æ’­æ”¾";
    }

    function togglePlay() {
        if(isPlaying) pause(); else play();
    }

    function stop() {
        if(isPlaying) {
            sourceNode.stop();
            sourceNode = null;
        }
        isPlaying = false;
        pauseOffset = 0;
        document.getElementById('play-btn').innerText = "â–¶ æ’­æ”¾";
        draw();
        updateUI(0);
    }

    function setSpeed(rate) {
        const wasPlaying = isPlaying;
        if(isPlaying) pause();
        playbackRate = rate;
        document.querySelectorAll('#toolbar button').forEach(b => b.classList.remove('active'));
        if(rate === 1.0) document.getElementById('btn-speed-1').classList.add('active');
        if(wasPlaying) play();
    }

    // æ‹–æ›³é€²åº¦æ¢
    slider.addEventListener('input', (e) => {
        const wasPlaying = isPlaying;
        if(isPlaying) pause();
        pauseOffset = parseFloat(e.target.value);
        if(wasPlaying) play();
        else draw();
        updateUI(pauseOffset);
    });

    // --- 4. ç·¨è¼¯èˆ‡äº’å‹• ---
    function resize() {
        canvas.width = document.getElementById('viewport').clientWidth;
        canvas.height = document.getElementById('viewport').clientHeight;
        if(!isPlaying) draw();
    }
    window.addEventListener('resize', resize);

    function zoom(delta) {
        TIME_WINDOW += delta;
        if(TIME_WINDOW < 1000) TIME_WINDOW = 1000;
        if(TIME_WINDOW > 10000) TIME_WINDOW = 10000;
        if(!isPlaying) draw();
        statusDiv.innerText = `è¦–çª—ç¸®æ”¾: ${TIME_WINDOW}ms`;
    }

    // éµç›¤éŒ„è£½
    window.addEventListener('keydown', (e) => {
        if(document.activeElement.tagName === 'TEXTAREA') return;
        const lane = LANE_KEYS.indexOf(e.key.toLowerCase());
        if(lane !== -1) {
            const now = getCurrentTime();
            // ç°¡å–®é˜²æŠ–
            if(!notes.find(n => n.lane === lane && Math.abs(n.time - now*1000) < 50)) {
                notes.push({ time: Math.round(now * 1000), lane: lane, hit: false });
                if(!isPlaying) draw();
            }
        }
        if(e.code === 'Space') { e.preventDefault(); togglePlay(); }
    });

    // æ»‘é¼ é»æ“Šç·¨è¼¯
    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const laneH = canvas.height / 4;
        const lane = Math.floor(y / laneH);
        
        // è¨ˆç®—é»æ“Šå°æ‡‰çš„æ™‚é–“
        const now = getCurrentTime();
        const widthMs = TIME_WINDOW; // ç•«é¢å¯¬åº¦ä»£è¡¨çš„æ™‚é–“
        const msPerPx = widthMs / canvas.width;
        
        // ç•«é¢ä¸­å¿ƒæ˜¯ nowï¼Œé»æ“Šè™•ç›¸å°æ–¼ä¸­å¿ƒçš„åç§»
        const centerX = canvas.width / 2;
        const offsetMs = (x - centerX) * msPerPx;
        const clickTimeMs = (now * 1000) + offsetMs;

        // æœå°‹é»æ“Šè™•æ˜¯å¦æœ‰éŸ³ç¬¦ (èª¤å·® 30ms)
        const hitIdx = notes.findIndex(n => n.lane === lane && Math.abs(n.time - clickTimeMs) < 150); // åŠ å¤§èª¤å·®å®¹è¨±ï¼Œæ¯”è¼ƒå¥½é»

        if(hitIdx !== -1) {
            notes.splice(hitIdx, 1); // åˆªé™¤
        } else {
            if(clickTimeMs >= 0) {
                notes.push({ time: Math.round(clickTimeMs), lane: lane, hit: false }); // æ–°å¢
            }
        }
        if(!isPlaying) draw();
    });

    // --- 5. ç¹ªåœ–æ ¸å¿ƒ ---
    function getCurrentTime() {
        if(isPlaying) {
            return pauseOffset + (audioCtx.currentTime - startTime) * playbackRate;
        }
        return pauseOffset;
    }

    function animate() {
        if(!isPlaying) return;
        draw();
        
        const curr = getCurrentTime();
        updateUI(curr);
        
        if(curr >= audioBuffer.duration) stop();
        else requestAnimationFrame(animate);
    }

    function updateUI(time) {
        slider.value = time;
        const m = Math.floor(time/60).toString().padStart(2,'0');
        const s = (time%60).toFixed(2).padStart(5,'0');
        timeDisp.innerText = `${m}:${s}`;
    }

    function draw() {
        const w = canvas.width;
        const h = canvas.height;
        const nowMs = getCurrentTime() * 1000;
        
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, w, h);

        // ç•«æ³¢å½¢ (SoundCloud é¢¨æ ¼ï¼šé¡åƒ)
        if(waveform.length > 0) {
            const startMs = nowMs - (TIME_WINDOW / 2);
            const endMs = nowMs + (TIME_WINDOW / 2);
            const msPerPx = TIME_WINDOW / w;

            // æ³¢å½¢æ•¸æ“šç´¢å¼• (æ¯ 10ms ä¸€é»)
            const startIdx = Math.floor(startMs / 10);
            const endIdx = Math.ceil(endMs / 10);
            
            ctx.beginPath();
            ctx.fillStyle = 'rgba(0, 188, 212, 0.3)'; // é’è‰²åŠé€æ˜

            for(let i = startIdx; i < endIdx; i++) {
                if(i < 0 || i >= waveform.length) continue;
                
                const val = waveform[i]; // 0~1 (å·²æ­£è¦åŒ–)
                const x = ((i * 10) - startMs) / msPerPx;
                
                // ç•« bar
                // é«˜åº¦ = val * (h / 2)
                const barH = val * (h * 0.45); 
                
                // å¦‚æœæ˜¯å¤§èƒ½é‡ï¼Œç•«æ›´äº®
                if(val > 0.6) {
                    ctx.fillStyle = `rgba(0, 255, 255, ${val})`; 
                } else {
                    ctx.fillStyle = `rgba(0, 150, 150, 0.4)`;
                }
                
                // ç•«ä¸ŠåŠéƒ¨
                ctx.fillRect(x, (h/2) - barH, 2, barH * 2); 
            }
        }

        // ç•«ç¶²æ ¼ (Beat Grid)
        const msPerPx = TIME_WINDOW / w;
        const startMs = nowMs - (TIME_WINDOW / 2);
        const endMs = nowMs + (TIME_WINDOW / 2);
        
        ctx.fillStyle = '#444';
        ctx.font = '10px monospace';
        ctx.textAlign = 'center';

        // æ¯ç§’ç•«ä¸€æ¢ç²—ç·šï¼Œæ¯ 0.5 ç§’ç•«ç´°ç·š
        const gridStart = Math.floor(startMs / 500) * 500;
        for(let t = gridStart; t < endMs; t += 500) {
            const x = (t - startMs) / msPerPx;
            const isSec = (t % 1000 === 0);
            
            ctx.fillStyle = isSec ? '#555' : '#333';
            ctx.fillRect(x, 0, 1, h);
            
            if(isSec) {
                ctx.fillStyle = '#888';
                ctx.fillText((t/1000).toFixed(0)+'s', x, h - 5);
            }
        }

        // ç•«éŸ³ç¬¦
        const laneH = h / 4;
        const visibleNotes = notes.filter(n => n.time > startMs - 100 && n.time < endMs + 100);
        
        visibleNotes.forEach(n => {
            const x = (n.time - startMs) / msPerPx;
            const y = n.lane * laneH;
            const color = LANE_COLORS[n.lane];
            
            // æ–¹å¡Šæœ¬é«”
            ctx.fillStyle = color;
            ctx.shadowBlur = 10; ctx.shadowColor = color;
            // å¯¬åº¦ç¨å¾®å¯¬ä¸€é»å¥½é»é¸
            ctx.fillRect(x - 3, y + 2, 6, laneH - 4);
            
            ctx.shadowBlur = 0;
            ctx.strokeStyle = '#fff';
            ctx.strokeRect(x - 3, y + 2, 6, laneH - 4);
        });
        
        // è»Œé“æ©«ç·š
        for(let i=1; i<4; i++) {
            ctx.fillStyle = '#333';
            ctx.fillRect(0, i*laneH, w, 1);
        }
    }

    // --- åŒ¯å‡º ---
    function toggleExport() {
        const modal = document.getElementById('export-modal');
        if(modal.style.display === 'flex') modal.style.display = 'none';
        else {
            modal.style.display = 'flex';
            notes.sort((a,b) => a.time - b.time);
            document.getElementById('json-text').value = JSON.stringify(notes);
        }
    }
    function copyJson() {
        document.getElementById('json-text').select();
        document.execCommand('copy');
        alert("è¤‡è£½æˆåŠŸï¼è«‹è²¼ä¸Šåˆ°éŠæˆ²ä¸­ã€‚");
    }

</script>
</body>
</html>